<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Test Athenaa PSI via WebAssembly</title>
</head>
<body>
  <h2>Test Athenaa PSI via WebAssembly</h2>
  <button id="launch">Lancer PSI</button>
  <pre id="output">Chargement du module...</pre>

  <script src="athenaa.js"></script>
  <script>
    Module.onRuntimeInitialized = () => {
      const $btn = document.getElementById("launch");
      const $out = document.getElementById("output");
      $out.textContent = "Module WebAssembly prêt ✅";

      $btn.addEventListener("click", () => {
        const scalar = new Uint8Array(32).fill(1);
        const key = new Uint8Array(32).fill(2);
        const nonce = new Uint8Array(8).fill(3);
        const word = new TextEncoder().encode("secret2");

        const ptrScalar = Module._malloc(32);
        const ptrKey = Module._malloc(32);
        const ptrNonce = Module._malloc(8);
        const ptrWord = Module._malloc(word.length);
        const ptrOut = Module._malloc(32);

        Module.HEAPU8.set(scalar, ptrScalar);
        Module.HEAPU8.set(key, ptrKey);
        Module.HEAPU8.set(nonce, ptrNonce);
        Module.HEAPU8.set(word, ptrWord);

        Module.ccall("psi_compute", "void",
          ["number", "number", "number", "number", "number", "number"],
          [ptrScalar, ptrKey, ptrNonce, ptrWord, word.length, ptrOut]
        );

        const result = Module.HEAPU8.slice(ptrOut, ptrOut + 32);
        const hex = Array.from(result).map(b => b.toString(16).padStart(2, "0")).join("");
        $out.textContent = "Résultat SHA256 :\\n" + hex;

        Module._free(ptrScalar);
        Module._free(ptrKey);
        Module._free(ptrNonce);
        Module._free(ptrWord);
        Module._free(ptrOut);
      });
    };
  </script>
</body>
</html>
